- name: test-integration-no-cluster
  tags:
    - integration
  command: >
    snakemake
    --use-singularity
    --singularity-prefix /tmp/singularity
    --singularity-args ' --cleanenv --bind /tmp'
    --jobs 1 -w 120
    -r -p -s Snakefile
    --config
    CONFIG_JSON=tests/data/config/sample_config.json
  stderr:
    contains:
      - "Job counts"
      - "localrule all:"
      - "(100%) done"
    must_not_contain:
      - "rror"
  files:
   - path: "micro/vcf/micro.vcf.gz"
     contains:
             - "chrM\t152\t.\tT\tC\t3960.77\t."
             - "GT:AD:DP:GQ:PL\t1/1:0,130:130:99:3989,388,0"

             - "chrM\t263\t.\tA\tG\t3233.06\t."
             - "GT:AD:DP:GQ:PL\t1/1:0,108:108:99:3263,323,0"

             - "chrM\t4745\t.\tA\tG\t5655.77\t."
             - "GT:AD:DP:GQ:PGT:PID:PL\t1/1:1,133:134:99:1|1:4745_A_G:5684,404,0"

             - "chrM\t4769\t.\tA\tG\t5182.77\t."
             - "GT:AD:DP:GQ:PGT:PID:PL\t1/1:1,120:121:99:1|1:4745_A_G:5211,363,0"

             - "chrM\t16023\t.\tG\tA\t1880.77\t."
             - "GT:AD:DP:GQ:PL\t0/1:72,73:145:99:1909,0,1872"

   - path: "micro/vcf/micro.g.vcf.gz"
     contains:
             - "chrM\t1\t.\tG\t<NON_REF>\t.\t.\tEND=151\tGT:DP:GQ:MIN_DP:PL\t0/0:165:99:137:0,120,1800"

             - "chrM\t152\t.\tT\tC,<NON_REF>\t3960.77"
             - "GT:AD:DP:GQ:PL:SB\t1/1:0,130,0:130:99:3989,388,0,3989,388,3989:0,0,47,83"

             - "chrM\t16023\t.\tG\tA,<NON_REF>\t1880.77\t."
             - "GT:AD:DP:GQ:PL:SB\t0/1:72,73,0:145:99:1909,0,1872,2125,2089,4214:35,37,36,37"

             - "chrM\t16560\t.\tC\t<NON_REF>\t.\t.\tEND=16569\tGT:DP:GQ:MIN_DP:PL\t0/0:188:0:180:0,0,0"

- name: test-integration-small-scatter
  tags:
    - integration
  command: >
    snakemake
    --use-singularity
    --singularity-prefix /tmp/singularity
    --singularity-args ' --cleanenv --bind /tmp'
    --jobs 1 -w 120
    -r -p -s Snakefile
    --config
    CONFIG_JSON=tests/data/config/sample_config_scatter.json
  stderr:
    contains:
      - "Job counts"
      - "localrule all:"
      - "(100%) done"
    must_not_contain:
      - "rror"
  files:
   - path: "scatter/scatter-0.bed"
   - path: "scatter/scatter-15.bed"
   - path: "micro/vcf/micro.vcf.gz.tbi"
   - path: "micro/vcf/micro.vcf.gz"
     contains:
             - "chrM\t152\t.\tT\tC\t3960.77\t."
             - "GT:AD:DP:GQ:PL\t1/1:0,130:130:99:3989,388,0"

             - "chrM\t263\t.\tA\tG\t3233.06\t."
             - "GT:AD:DP:GQ:PL\t1/1:0,108:108:99:3263,323,0"

             - "chrM\t4745\t.\tA\tG\t5655.77\t."
             - "GT:AD:DP:GQ:PGT:PID:PL\t1/1:1,133:134:99:1|1:4745_A_G:5684,404,0"

             - "chrM\t4769\t.\tA\tG\t5182.77\t."
             - "GT:AD:DP:GQ:PGT:PID:PL\t1/1:1,120:121:99:1|1:4745_A_G:5211,363,0"

             - "chrM\t16023\t.\tG\tA\t1880.77\t."
             - "GT:AD:DP:GQ:PL\t0/1:72,73:145:99:1909,0,1872"

   - path: "micro/vcf/micro.g.vcf.gz"
     contains:
             - "chrM\t1\t.\tG\t<NON_REF>\t.\t.\tEND=151\tGT:DP:GQ:MIN_DP:PL\t0/0:165:99:137:0,120,1800"

             - "chrM\t152\t.\tT\tC,<NON_REF>\t3960.77"
             - "GT:AD:DP:GQ:PL:SB\t1/1:0,130,0:130:99:3989,388,0,3989,388,3989:0,0,47,83"

             - "chrM\t16023\t.\tG\tA,<NON_REF>\t1880.77\t."
             - "GT:AD:DP:GQ:PL:SB\t0/1:72,73,0:145:99:1909,0,1872,2125,2089,4214:35,37,36,37"

             - "chrM\t16560\t.\tC\t<NON_REF>\t.\t.\tEND=16569\tGT:DP:GQ:MIN_DP:PL\t0/0:188:0:180:0,0,0"
   - path: "micro/vcf/micro.g.vcf.gz.tbi"
   - path: "micro/vcf/micro.0.vcf.gz"
     should_exist: false
   - path: "micro/vcf/micro.0.vcf.gz.tbi"
     should_exist: false

- name: test-integration-refflat
  tags:
    - integration
  command: >
    snakemake
    --use-singularity
    --singularity-prefix /tmp/singularity
    --singularity-args ' --cleanenv --bind /tmp'
    --jobs 1 -w 120
    -r -p -s Snakefile
    --config
    CONFIG_JSON=tests/data/config/sample_config_refflat.json
  stderr:
    contains:
      - "Job counts"
      - "localrule all:"
      - "(100%) done"
    must_not_contain:
      - "rror"
  files:
   - path: "micro/coverage/refFlat_coverage.tsv"
     contains:
         - "1\tMIR12136\t133.0\t99.0\t133.0\t99.0\t100.0\t100.0\t100.0\t100.0\t100.0\t100.0\t100.0\t100.0\t100.0\t100.0\tNR_162149"

- name: test-integration-all-on-target
  tags:
    - integration
  command: >
    snakemake
    --use-singularity
    --singularity-prefix /tmp/singularity
    --singularity-args ' --cleanenv --bind /tmp'
    --jobs 1 -w 120
    -r -p -s Snakefile
    --config
    CONFIG_JSON=tests/data/config/sample_config_bed_all.json
  stderr:
    contains:
      - "Job counts"
      - "localrule all:"
      - "(100%) done"
    must_not_contain:
      - "rror"
  files:
   - path: "micro/coverage/covstats.png"
   - path: "micro/coverage/covstats.json"
     contains:
       - "\"frac_min_100x\": 0.9748"
       - "\"mean\": 136.70"
       - "\"width_nonzero\": 16569"
   - path: "stats.tsv"
     contains:
       - "sample_name\tpreqc_reads\tpreqc_bases\tpostqc_reads\tpostqc_bases\tmapped_reads\tmapped_bases\tusable_reads\tusable_bases\ttotal_variants\tsnps\tinsertions\tdeletions\ttransversions\ttransitions\tti_tv_ratio\thomozygous_variants\theterozygous_variants\tcovstats.json_median_coverage"
       - "micro\t15440\t2276743\t15398\t2269171\t15515\t2275114\t15477\t2270739\t17\t15\t2\t0\t0\t15\tnan\t16\t1\t136"

       - "\tcovstats.json_modal_coverage\tcovstats.json_horizontal_coverage\t"
       - "\t137\t1.0\t"

- name: test-integration-two-known-sites
  tags:
    - integration
  command: >
    snakemake
    --use-singularity
    --singularity-prefix /tmp/singularity
    --singularity-args ' --cleanenv --bind /tmp'
    --jobs 1 -w 120
    -r -p -s Snakefile
    --config
    CONFIG_JSON=tests/data/config/sample_config_two_known_vcf.json
  stderr:
    contains:
      - "Job counts"
      - "localrule all:"
      - "(100%) done"
      - "-knownSites tests/data/database.vcf.gz -knownSites tests/data/database.vcf.gz"
    must_not_contain:
      - "rror"
